name: Testing
on:
  push:
    branches:
    - main
jobs:
  test:
    name: Testing Swift Package and iOS app
    runs-on: macos-12
    steps:
      - name: Checkout repository
        uses: actions/checkout@v1
      - name: Select Xcode
        run: sudo xcode-select -switch /Applications/Xcode_13.1.app && /usr/bin/xcodebuild -version
      - name: Prepare iOS 15.0 simulator
        run: |
          sudo mkdir -p /Library/Developer/CoreSimulator/Profiles/Runtimes
          sudo ln -s /Applications/Xcode_13.1.app/Contents/Developer/Platforms/iPhoneOS.platform/Library/Developer/CoreSimulator/Profiles/Runtimes/iOS.simruntime /Library/Developer/CoreSimulator/Profiles/Runtimes/iOS\ 15.0.simruntime
          xcrun simctl list runtimes
          xcrun simctl create iPhone_12 "iPhone 12" "com.apple.CoreSimulator.SimRuntime.iOS-15-0"
          xcrun simctl list devices 15.0
      - name: Show Build Settings
        run: xcodebuild -workspace DemoToptalCI.xcworkspace -scheme DemoToptalCI -showBuildSettings
#      - name: Testing Swift package
#        run: exec ./.github/scripts/test_swift_package.sh
      - name: Testing iOS app
        run: xcodebuild test -scheme DemoToptalCI -workspace DemoToptalCI.xcworkspace -destination 'platform=iOS Simulator,name=iPhone_12' | xcpretty && exit ${PIPESTATUS[0]}
